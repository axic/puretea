// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";

import "../src/Puretea.sol";

// Could use uint8[], but array literals can't be passed to dynamic arrays yet.
function generateMask(bytes memory allowedOpcodes) pure returns (uint256 mask) {
    for (uint256 i = 0; i < allowedOpcodes.length; i++) {
        mask |= 1 << uint8(allowedOpcodes[i]);
    }
}

contract PureteaTest is Test {
    function testSmoke() public {
        assertEq(Puretea.isPureGlobal(hex""), true); // empty
        assertEq(Puretea.isPureGlobal(hex"00"), true); // STOP
        assertEq(Puretea.isPureGlobal(hex"6000"), true); // PUSH1 00
        assertEq(Puretea.isPureGlobal(hex"60"), false); // truncated PUSH1
        assertEq(Puretea.isPureGlobal(hex"fe"), true); // REVERT
        assertEq(Puretea.isPureGlobal(hex"ff"), false); // SELFDESTRUCT
    }

    function testCustomMask() public {
        uint256 mask = generateMask(hex"00_20_fe");
        assertEq(mask, 0x4000000000000000000000000000000000000000000000000000000100000001);
        assertTrue(Puretea.check(hex"", mask));
        assertTrue(Puretea.check(hex"00", mask));
        assertTrue(Puretea.check(hex"20", mask));
        assertTrue(Puretea.check(hex"20fe0020fefe", mask));
        assertFalse(Puretea.check(hex"ff", mask));
    }

    function testMutating() public {
        uint256 mask = generateMask(hex"000102030405060708090a0b_101112131415161718191a1b1c1d_20_303132333435363738393a3b3c3d3e3f_404142434445464748_505152535455565758595a5b_606162636465666768696a6b6c6d6e6f_707172737475767778797a7b7c7d7e7f_808182838485868788898a8b8c8d8e8f_909192939495969798999a9b9c9d9e9f_a0a1a2a3a4_f0f1f2f3f4f5fafdfeff");
        assertEq(mask, 0xe43f0000000000000000001fffffffffffffffff0fff01ffffff00013fff0fff);
        assertTrue(Puretea.isMutating(hex""));
        assertTrue(Puretea.isMutating(hex"611234f0"));
        assertFalse(Puretea.isMutating(hex"21"));
    }

    function testView() public {
        uint256 mask = generateMask(hex"000102030405060708090a0b_101112131415161718191a1b1c1d_20_303132333435363738393a3b3c3d3e3f_404142434445464748_5051525354565758595a5b_606162636465666768696a6b6c6d6e6f_707172737475767778797a7b7c7d7e7f_808182838485868788898a8b8c8d8e8f_909192939495969798999a9b9c9d9e9f_f3fafdfe");
        assertEq(mask, 0x640800000000000000000000ffffffffffffffff0fdf01ffffff00013fff0fff);
        assertTrue(Puretea.isView(hex""));
        assertTrue(Puretea.isView(hex"611234fe"));
        assertFalse(Puretea.isView(hex"f0"));
    }

    function testPureGlobal() public {
        uint256 mask = generateMask(hex"000102030405060708090a0b_101112131415161718191a1b1c1d_20_303132333435363738393a3d3e_404142434445464748_5051525354565758595a5b_606162636465666768696a6b6c6d6e6f_707172737475767778797a7b7c7d7e7f_808182838485868788898a8b8c8d8e8f_909192939495969798999a9b9c9d9e9f_f3fdfe");
        assertEq(mask, 0x600800000000000000000000ffffffffffffffff0fdf01ff67ff00013fff0fff);
        assertTrue(Puretea.isPureGlobal(hex""));
        assertTrue(Puretea.isPureGlobal(hex"61123400"));
        assertFalse(Puretea.isPureGlobal(hex"fa"));
    }

    function testPureLocal() public {
        uint256 mask = generateMask(hex"000102030405060708090a0b_101112131415161718191a1b1c1d_20_303132333435363738393a3b3c3d3e3f_404142434445464748_50515253565758595a5b_606162636465666768696a6b6c6d6e6f_707172737475767778797a7b7c7d7e7f_808182838485868788898a8b8c8d8e8f_909192939495969798999a9b9c9d9e9f_f3fdfe");
        assertEq(mask, 0x600800000000000000000000ffffffffffffffff0fcf01ffffff00013fff0fff);
        assertTrue(Puretea.isPureLocal(hex""));
        assertTrue(Puretea.isPureLocal(hex"61123400"));
        assertFalse(Puretea.isPureLocal(hex"fa"));
    }

    function testRealCode() public {
        bytes memory code = hex"6080604052348015600f57600080fd5b50604580601d6000396000f3fe608060405236600a57005b600080fdfe";
        assertTrue(Puretea.isMutating(code));
        assertTrue(Puretea.isView(code));
        assertTrue(Puretea.isPureGlobal(code));
        assertTrue(Puretea.isPureLocal(code));
    }

    function testComplexCode() public {
        bytes memory code = hex"608060048036101561001057600080fd5b600090813560e01c63545165201461002757600080fd5b346100df5760603660031901126100df57366064116100df576060830183811067ffffffffffffffff8211176100cc576040526060368437815b60038110610094576040518385825b6003831061007d57606084f35b600190825181526020809101920192019190610070565b8060051b6100a48184013561010c565b9085015260001981146100b957600101610061565b634e487b7160e01b835260118252602483fd5b634e487b7160e01b835260418252602483fd5b5080fd5b80600019048211811515166100f6570290565b634e487b7160e01b600052601160045260246000fd5b6001916000808484106101d15760001991848301905b8181106101605760405162461bcd60e51b815260206004820152600f60248201526e77726f6e6720616c676f726974686d60881b6044820152606490fd5b808216818318881c019060011982116101f957878201878061018285806100e3565b111591826101e5575b50506101b2578661019c83806100e3565b10156101ab5750905b90610122565b91506101a5565b509395505090925081633b9aca0093048311821515166101d157500290565b634e487b7160e01b81526011600452602490fd5b6101f1919250806100e3565b11873861018b565b634e487b7160e01b84526011600452602484fdfe";
        uint256 mask = 0x6008_0000_0000_0000_0000_001f_ffff_ffff_ffff_ffff_0fdf_01ff_ffff_0001_3fff_0fff;
        assertTrue(Puretea.check(code, mask));
    }

    function testComplexCodeBranchless() public {
        bytes memory code = hex"608060048036101561001057600080fd5b600090813560e01c63545165201461002757600080fd5b346100df5760603660031901126100df57366064116100df576060830183811067ffffffffffffffff8211176100cc576040526060368437815b60038110610094576040518385825b6003831061007d57606084f35b600190825181526020809101920192019190610070565b8060051b6100a48184013561010c565b9085015260001981146100b957600101610061565b634e487b7160e01b835260118252602483fd5b634e487b7160e01b835260418252602483fd5b5080fd5b80600019048211811515166100f6570290565b634e487b7160e01b600052601160045260246000fd5b6001916000808484106101d15760001991848301905b8181106101605760405162461bcd60e51b815260206004820152600f60248201526e77726f6e6720616c676f726974686d60881b6044820152606490fd5b808216818318881c019060011982116101f957878201878061018285806100e3565b111591826101e5575b50506101b2578661019c83806100e3565b10156101ab5750905b90610122565b91506101a5565b509395505090925081633b9aca0093048311821515166101d157500290565b634e487b7160e01b81526011600452602490fd5b6101f1919250806100e3565b11873861018b565b634e487b7160e01b84526011600452602484fdfe";
        uint256 mask = 0x6008_0000_0000_0000_0000_001f_ffff_ffff_ffff_ffff_0fdf_01ff_ffff_0001_3fff_0fff;
        assertTrue(Puretea.checkBranchless(code, mask));
    }
}
